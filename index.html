<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Cartas de Magias D&D</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 20px 100px;
        }

        h1 {
            text-align: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: #ccc;
            cursor: pointer;
            font-size: 16px;
            border-radius: 8px 8px 0 0;
            transition: background-color 0.3s;
        }

        .tab-button.active {
            background: #2980b9;
            color: white;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .character-info {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .character-info input,
        .character-info select,
        .filter-form input,
        .filter-form select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .save-button {
            display: block;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 20px;
        }

        .save-button:hover {
            opacity: 0.9;
        }

        .filter-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: scroll;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .card h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .field {
            margin-bottom: 6px;
        }

        .classes {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .class-tag {
            background: #555;
            padding: 4px 8px;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: bold;
        }

        .Artífice {
            background: #34495e;
        }

        .Bardo {
            background: #cf20b8;
        }

        .Bruxo {
            background: #890ea8;
        }

        .Druida {
            background: #08a880;
        }

        .Feiticeiro {
            background: #cc1c1c;
        }

        .Mago {
            background: #2980b9;
        }

        .Lutador {
            background: #e67e22;
        }

        .Ladino {
            background: #2e6dcc;
        }

        .Paladino {
            background: #ccc12e;
        }

        .Patrulheiro {
            background: #2ecc3b;
        }

        .Clérigo {
            background: #e2651c;
        }

        .text-section {
            margin-top: 10px;
            font-size: 14px;
        }

        .add-to-grimoire-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-top: 15px;
            border: none;
            border-radius: 8px;
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-to-grimoire-btn.remove {
            background-color: #e74c3c;
        }

        .add-to-grimoire-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <h1>Magias D&D</h1>

    <div class="character-info">
        <input type="text" id="charName" placeholder="Nome do Personagem">
        <input type="number" id="charLevel" placeholder="Nível" min="1" max="20">
        <input type="text" id="charRace" placeholder="Raça">
        <input type="text" id="charClass" placeholder="Classe">
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab('all-spells')">Todas as Magias</button>
        <button class="tab-button" onclick="openTab('grimoire')">Meu Grimório</button>
    </div>

    <div id="all-spells" class="tab-content active">
        <div class="filter-form">
            <input type="text" id="filterName" placeholder="Filtrar por nome...">
            <select id="filterSource">
                <option value="">Fonte (todas)</option>
            </select>
            <select id="filterLevel">
                <option value="">Nível (todos)</option>
            </select>
            <select id="filterSchool">
                <option value="">Escola (todas)</option>
            </select>
            <select id="filterClasses">
                <option value="">Classe (todas)</option>
            </select>
        </div>
        <div class="cards-container" id="cardsContainer"></div>
    </div>

    <div id="grimoire" class="tab-content">
        <button id="saveGrimoireBtn" class="save-button">Salvar Grimório</button>
        <div class="cards-container" id="grimoireContainer"></div>
    </div>

    <script>
        const JSON_URL = 'magias.json';
        const CACHE_KEY = 'dnd_data_cache';
        const GRIMOIRE_KEY = 'dnd_grimoire';
        const CHARACTER_INFO_KEY = 'dnd_character_info';

        let allSpells = [];
        let grimoireSpells = [];

        function renderSpells(containerId, spells, isGrimoireTab) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (spells.length === 0) {
                container.innerHTML = `<p style="text-align: center; font-style: italic;">Nenhuma magia encontrada.</p>`;
                return;
            }
            spells.forEach(spell => {
                const card = document.createElement("div");
                card.className = "card";

                const classTags = spell.classes.map(c => {
                    const className = c.split(" ")[0];
                    return `<span class="class-tag ${className}">${c}</span>`;
                }).join(" ");

                const buttonText = isGrimoireTab ? "Remover do Grimório" : "Adicionar ao Grimório";
                const buttonClass = isGrimoireTab ? "add-to-grimoire-btn remove" : "add-to-grimoire-btn";

                card.innerHTML = `
                    <div class="field"><strong>Fonte:</strong> ${spell.fonte}</div>
                    <h2>${spell.name}</h2>
                    <div class="field"><strong>Nível:</strong> ${spell.level}</div>
                    <div class="field"><strong>Escola:</strong> ${spell.school}</div>
                    <div class="field"><strong>Tempo de Conjuração:</strong> ${spell.time}</div>
                    <div class="field"><strong>Alcance:</strong> ${spell.range}</div>
                    <div class="field"><strong>Componentes:</strong> ${spell.components}</div>
                    <div class="field"><strong>Duração:</strong> ${spell.duration}</div>
                    <div class="field"><strong>Classes:</strong> <div class="classes">${classTags}</div></div>
                    <div class="text-section">${spell.text.map(t => `<p>${t}</p>`).join("")}</div>
                    <button class="${buttonClass}" data-spell-name="${spell.name}">${buttonText}</button>
                `;
                container.appendChild(card);
            });

            container.querySelectorAll('.add-to-grimoire-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const spellName = e.target.dataset.spellName;
                    if (isGrimoireTab) {
                        removeSpellFromGrimoire(spellName);
                    } else {
                        addSpellToGrimoire(spellName);
                    }
                });
            });
        }

        function populateFilters(spells) {
            const sources = [...new Set(spells.map(s => s.fonte))].sort();
            const levels = [...new Set(spells.map(s => s.level))].sort((a, b) => parseInt(a) - parseInt(b));
            const schools = [...new Set(spells.map(s => s.school))].sort();
            const classes = [...new Set(spells.flatMap(s => s.classes.map(c => c.split(" ")[0])))].sort();

            const filterSource = document.getElementById('filterSource');
            filterSource.innerHTML += sources.map(source => `<option value="${source}">${source}</option>`).join('');

            const filterLevel = document.getElementById('filterLevel');
            filterLevel.innerHTML += levels.map(level => `<option value="${level}">${level}</option>`).join('');

            const filterSchool = document.getElementById('filterSchool');
            filterSchool.innerHTML += schools.map(school => `<option value="${school}">${school}</option>`).join('');

            const filterClasses = document.getElementById('filterClasses');
            filterClasses.innerHTML += classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');
        }

        function filterSpells() {
            const filterName = document.getElementById('filterName').value.toLowerCase();
            const filterSource = document.getElementById('filterSource').value;
            const filterLevel = document.getElementById('filterLevel').value;
            const filterSchool = document.getElementById('filterSchool').value;
            const filterClasses = document.getElementById('filterClasses').value;

            const filteredSpells = allSpells.filter(spell => {
                const nameMatch = spell.name.toLowerCase().includes(filterName);
                const sourceMatch = !filterSource || spell.fonte === filterSource;
                const levelMatch = !filterLevel || spell.level === filterLevel;
                const schoolMatch = !filterSchool || spell.school === filterSchool;
                const classMatch = !filterClasses || spell.classes.some(c => c.split(" ")[0] === filterClasses);

                return nameMatch && sourceMatch && levelMatch && schoolMatch && classMatch;
            });

            renderSpells('cardsContainer', filteredSpells, false);
        }

        function addSpellToGrimoire(spellName) {
            const spell = allSpells.find(s => s.name === spellName);
            if (spell && !grimoireSpells.some(s => s.name === spellName)) {
                grimoireSpells.push(spell);
                alert(`Magia "${spellName}" adicionada ao grimório! Lembre-se de salvar para persistir.`);
            }
        }

        function removeSpellFromGrimoire(spellName) {
            grimoireSpells = grimoireSpells.filter(s => s.name !== spellName);
            renderSpells('grimoireContainer', grimoireSpells, true);
            alert(`Magia "${spellName}" removida do grimório! Lembre-se de salvar para persistir.`);
        }

        function saveEverything() {
            const characterInfo = {
                name: document.getElementById('charName').value,
                level: document.getElementById('charLevel').value,
                race: document.getElementById('charRace').value,
                class: document.getElementById('charClass').value
            };
            localStorage.setItem(CHARACTER_INFO_KEY, JSON.stringify(characterInfo));
            localStorage.setItem(GRIMOIRE_KEY, JSON.stringify(grimoireSpells));
            alert('Informações do personagem e grimório salvos!');
        }

        function loadEverything() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) {
                const { spells, timestamp } = JSON.parse(cachedData);
                const now = Date.now();
                const oneWeek = 7 * 24 * 60 * 60 * 1000;

                if (now - timestamp < oneWeek) {
                    allSpells = spells;
                    console.log('Magias carregadas do cache.');
                    return true;
                }
            }
            return false;
        }

        function cacheSpells(data) {
            const cacheData = {
                spells: data,
                timestamp: Date.now()
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            console.log('Magias salvas no cache.');
        }

        function loadCharacterInfo() {
            const characterInfo = JSON.parse(localStorage.getItem(CHARACTER_INFO_KEY));
            if (characterInfo) {
                document.getElementById('charName').value = characterInfo.name || '';
                document.getElementById('charLevel').value = characterInfo.level || '';
                document.getElementById('charRace').value = characterInfo.race || '';
                document.getElementById('charClass').value = characterInfo.class || '';
            }
        }

        function loadGrimoire() {
            const savedGrimoire = localStorage.getItem(GRIMOIRE_KEY);
            if (savedGrimoire) {
                grimoireSpells = JSON.parse(savedGrimoire);
            }
        }

        function openTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');

            if (tabId === 'grimoire') {
                renderSpells('grimoireContainer', grimoireSpells, true);
            } else {
                filterSpells();
            }
        }

        // --- Início da execução ---
        document.getElementById('saveGrimoireBtn').addEventListener('click', saveEverything);
        document.getElementById('filterName').addEventListener('keyup', filterSpells);
        document.getElementById('filterSource').addEventListener('change', filterSpells);
        document.getElementById('filterLevel').addEventListener('change', filterSpells);
        document.getElementById('filterSchool').addEventListener('change', filterSpells);
        document.getElementById('filterClasses').addEventListener('change', filterSpells);

        if (loadEverything()) {
            loadGrimoire();
            loadCharacterInfo();
            populateFilters(allSpells);
            filterSpells();
        } else {
            fetch(JSON_URL)
                .then(res => res.json())
                .then(data => {
                    allSpells = data;
                    cacheSpells(data);
                    loadGrimoire();
                    loadCharacterInfo();
                    populateFilters(allSpells);
                    filterSpells();
                })
                .catch(err => {
                    document.body.innerHTML = `<p>Erro ao carregar o arquivo JSON.</p>`;
                    console.error(err);
                });
        }
    </script>
</body>

</html>